<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Termux 的作者 @fornwall**，在2017&#x2F;4&#x2F;16發了一個 **Issue #933**， 說在使用 **libgpg-error 時遇到一些問題。">
<meta property="og:type" content="article">
<meta property="og:title" content="Termux and atexit in Android">
<meta property="og:url" content="http://yumaokao.github.io/tw/termux/termux-so-atexit/index.html">
<meta property="og:site_name" content="YMK&#39;s Blog">
<meta property="og:description" content="Termux 的作者 @fornwall**，在2017&#x2F;4&#x2F;16發了一個 **Issue #933**， 說在使用 **libgpg-error 時遇到一些問題。">
<meta property="og:locale">
<meta property="article:published_time" content="2017-05-16T03:29:38.000Z">
<meta property="article:modified_time" content="2017-05-16T03:29:38.000Z">
<meta property="article:author" content="yumaokao">
<meta property="article:tag" content="termux">
<meta property="article:tag" content="commandline">
<meta property="article:tag" content="android">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Category: termux</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <style>
      svg:not(:root).svg-inline--fa {
  overflow: visible;
}

.svg-inline--fa {
  display: inline-block;
  font-size: inherit;
  height: 1em;
  overflow: visible;
  vertical-align: -0.125em;
}
.svg-inline--fa.fa-lg {
  vertical-align: -0.225em;
}
.svg-inline--fa.fa-w-1 {
  width: 0.0625em;
}
.svg-inline--fa.fa-w-2 {
  width: 0.125em;
}
.svg-inline--fa.fa-w-3 {
  width: 0.1875em;
}
.svg-inline--fa.fa-w-4 {
  width: 0.25em;
}
.svg-inline--fa.fa-w-5 {
  width: 0.3125em;
}
.svg-inline--fa.fa-w-6 {
  width: 0.375em;
}
.svg-inline--fa.fa-w-7 {
  width: 0.4375em;
}
.svg-inline--fa.fa-w-8 {
  width: 0.5em;
}
.svg-inline--fa.fa-w-9 {
  width: 0.5625em;
}
.svg-inline--fa.fa-w-10 {
  width: 0.625em;
}
.svg-inline--fa.fa-w-11 {
  width: 0.6875em;
}
.svg-inline--fa.fa-w-12 {
  width: 0.75em;
}
.svg-inline--fa.fa-w-13 {
  width: 0.8125em;
}
.svg-inline--fa.fa-w-14 {
  width: 0.875em;
}
.svg-inline--fa.fa-w-15 {
  width: 0.9375em;
}
.svg-inline--fa.fa-w-16 {
  width: 1em;
}
.svg-inline--fa.fa-w-17 {
  width: 1.0625em;
}
.svg-inline--fa.fa-w-18 {
  width: 1.125em;
}
.svg-inline--fa.fa-w-19 {
  width: 1.1875em;
}
.svg-inline--fa.fa-w-20 {
  width: 1.25em;
}
.svg-inline--fa.fa-pull-left {
  margin-right: 0.3em;
  width: auto;
}
.svg-inline--fa.fa-pull-right {
  margin-left: 0.3em;
  width: auto;
}
.svg-inline--fa.fa-border {
  height: 1.5em;
}
.svg-inline--fa.fa-li {
  width: 2em;
}
.svg-inline--fa.fa-fw {
  width: 1.25em;
}

.fa-layers svg.svg-inline--fa {
  bottom: 0;
  left: 0;
  margin: auto;
  position: absolute;
  right: 0;
  top: 0;
}

.fa-layers {
  display: inline-block;
  height: 1em;
  position: relative;
  text-align: center;
  vertical-align: -0.125em;
  width: 1em;
}
.fa-layers svg.svg-inline--fa {
  -webkit-transform-origin: center center;
          transform-origin: center center;
}

.fa-layers-counter, .fa-layers-text {
  display: inline-block;
  position: absolute;
  text-align: center;
}

.fa-layers-text {
  left: 50%;
  top: 50%;
  -webkit-transform: translate(-50%, -50%);
          transform: translate(-50%, -50%);
  -webkit-transform-origin: center center;
          transform-origin: center center;
}

.fa-layers-counter {
  background-color: #ff253a;
  border-radius: 1em;
  -webkit-box-sizing: border-box;
          box-sizing: border-box;
  color: #fff;
  height: 1.5em;
  line-height: 1;
  max-width: 5em;
  min-width: 1.5em;
  overflow: hidden;
  padding: 0.25em;
  right: 0;
  text-overflow: ellipsis;
  top: 0;
  -webkit-transform: scale(0.25);
          transform: scale(0.25);
  -webkit-transform-origin: top right;
          transform-origin: top right;
}

.fa-layers-bottom-right {
  bottom: 0;
  right: 0;
  top: auto;
  -webkit-transform: scale(0.25);
          transform: scale(0.25);
  -webkit-transform-origin: bottom right;
          transform-origin: bottom right;
}

.fa-layers-bottom-left {
  bottom: 0;
  left: 0;
  right: auto;
  top: auto;
  -webkit-transform: scale(0.25);
          transform: scale(0.25);
  -webkit-transform-origin: bottom left;
          transform-origin: bottom left;
}

.fa-layers-top-right {
  right: 0;
  top: 0;
  -webkit-transform: scale(0.25);
          transform: scale(0.25);
  -webkit-transform-origin: top right;
          transform-origin: top right;
}

.fa-layers-top-left {
  left: 0;
  right: auto;
  top: 0;
  -webkit-transform: scale(0.25);
          transform: scale(0.25);
  -webkit-transform-origin: top left;
          transform-origin: top left;
}

.fa-lg {
  font-size: 1.3333333333em;
  line-height: 0.75em;
  vertical-align: -0.0667em;
}

.fa-xs {
  font-size: 0.75em;
}

.fa-sm {
  font-size: 0.875em;
}

.fa-1x {
  font-size: 1em;
}

.fa-2x {
  font-size: 2em;
}

.fa-3x {
  font-size: 3em;
}

.fa-4x {
  font-size: 4em;
}

.fa-5x {
  font-size: 5em;
}

.fa-6x {
  font-size: 6em;
}

.fa-7x {
  font-size: 7em;
}

.fa-8x {
  font-size: 8em;
}

.fa-9x {
  font-size: 9em;
}

.fa-10x {
  font-size: 10em;
}

.fa-fw {
  text-align: center;
  width: 1.25em;
}

.fa-ul {
  list-style-type: none;
  margin-left: 2.5em;
  padding-left: 0;
}
.fa-ul > li {
  position: relative;
}

.fa-li {
  left: -2em;
  position: absolute;
  text-align: center;
  width: 2em;
  line-height: inherit;
}

.fa-border {
  border: solid 0.08em #eee;
  border-radius: 0.1em;
  padding: 0.2em 0.25em 0.15em;
}

.fa-pull-left {
  float: left;
}

.fa-pull-right {
  float: right;
}

.fa.fa-pull-left,
.fas.fa-pull-left,
.far.fa-pull-left,
.fal.fa-pull-left,
.fab.fa-pull-left {
  margin-right: 0.3em;
}
.fa.fa-pull-right,
.fas.fa-pull-right,
.far.fa-pull-right,
.fal.fa-pull-right,
.fab.fa-pull-right {
  margin-left: 0.3em;
}

.fa-spin {
  -webkit-animation: fa-spin 2s infinite linear;
          animation: fa-spin 2s infinite linear;
}

.fa-pulse {
  -webkit-animation: fa-spin 1s infinite steps(8);
          animation: fa-spin 1s infinite steps(8);
}

@-webkit-keyframes fa-spin {
  0% {
    -webkit-transform: rotate(0deg);
            transform: rotate(0deg);
  }
  100% {
    -webkit-transform: rotate(360deg);
            transform: rotate(360deg);
  }
}

@keyframes fa-spin {
  0% {
    -webkit-transform: rotate(0deg);
            transform: rotate(0deg);
  }
  100% {
    -webkit-transform: rotate(360deg);
            transform: rotate(360deg);
  }
}
.fa-rotate-90 {
  -ms-filter: "progid:DXImageTransform.Microsoft.BasicImage(rotation=1)";
  -webkit-transform: rotate(90deg);
          transform: rotate(90deg);
}

.fa-rotate-180 {
  -ms-filter: "progid:DXImageTransform.Microsoft.BasicImage(rotation=2)";
  -webkit-transform: rotate(180deg);
          transform: rotate(180deg);
}

.fa-rotate-270 {
  -ms-filter: "progid:DXImageTransform.Microsoft.BasicImage(rotation=3)";
  -webkit-transform: rotate(270deg);
          transform: rotate(270deg);
}

.fa-flip-horizontal {
  -ms-filter: "progid:DXImageTransform.Microsoft.BasicImage(rotation=0, mirror=1)";
  -webkit-transform: scale(-1, 1);
          transform: scale(-1, 1);
}

.fa-flip-vertical {
  -ms-filter: "progid:DXImageTransform.Microsoft.BasicImage(rotation=2, mirror=1)";
  -webkit-transform: scale(1, -1);
          transform: scale(1, -1);
}

.fa-flip-both, .fa-flip-horizontal.fa-flip-vertical {
  -ms-filter: "progid:DXImageTransform.Microsoft.BasicImage(rotation=2, mirror=1)";
  -webkit-transform: scale(-1, -1);
          transform: scale(-1, -1);
}

:root .fa-rotate-90,
:root .fa-rotate-180,
:root .fa-rotate-270,
:root .fa-flip-horizontal,
:root .fa-flip-vertical,
:root .fa-flip-both {
  -webkit-filter: none;
          filter: none;
}

.fa-stack {
  display: inline-block;
  height: 2em;
  position: relative;
  width: 2.5em;
}

.fa-stack-1x,
.fa-stack-2x {
  bottom: 0;
  left: 0;
  margin: auto;
  position: absolute;
  right: 0;
  top: 0;
}

.svg-inline--fa.fa-stack-1x {
  height: 1em;
  width: 1.25em;
}
.svg-inline--fa.fa-stack-2x {
  height: 2em;
  width: 2.5em;
}

.fa-inverse {
  color: #fff;
}

.sr-only {
  border: 0;
  clip: rect(0, 0, 0, 0);
  height: 1px;
  margin: -1px;
  overflow: hidden;
  padding: 0;
  position: absolute;
  width: 1px;
}

.sr-only-focusable:active, .sr-only-focusable:focus {
  clip: auto;
  height: auto;
  margin: 0;
  overflow: visible;
  position: static;
  width: auto;
}

.svg-inline--fa .fa-primary {
  fill: var(--fa-primary-color, currentColor);
  opacity: 1;
  opacity: var(--fa-primary-opacity, 1);
}

.svg-inline--fa .fa-secondary {
  fill: var(--fa-secondary-color, currentColor);
  opacity: 0.4;
  opacity: var(--fa-secondary-opacity, 0.4);
}

.svg-inline--fa.fa-swap-opacity .fa-primary {
  opacity: 0.4;
  opacity: var(--fa-secondary-opacity, 0.4);
}

.svg-inline--fa.fa-swap-opacity .fa-secondary {
  opacity: 1;
  opacity: var(--fa-primary-opacity, 1);
}

.svg-inline--fa mask .fa-primary,
.svg-inline--fa mask .fa-secondary {
  fill: black;
}

.fad.fa-inverse {
  color: #fff;
}
    </style>
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 5.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">root</a></li>
         
          <li><a href="/archives/">archives</a></li>
         
          <li><a href="/categories/">categories</a></li>
         
          <li><a href="/tags/">tags</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/tw/environment/multiple-hostnames-in-ssh-config/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/tw/termux/termux-env-setup/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://yumaokao.github.io/tw/termux/termux-so-atexit/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://yumaokao.github.io/tw/termux/termux-so-atexit/&text=Termux and atexit in Android"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://yumaokao.github.io/tw/termux/termux-so-atexit/&title=Termux and atexit in Android"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yumaokao.github.io/tw/termux/termux-so-atexit/&is_video=false&description=Termux and atexit in Android"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Termux and atexit in Android&body=Check out this article: http://yumaokao.github.io/tw/termux/termux-so-atexit/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://yumaokao.github.io/tw/termux/termux-so-atexit/&title=Termux and atexit in Android"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://yumaokao.github.io/tw/termux/termux-so-atexit/&title=Termux and atexit in Android"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://yumaokao.github.io/tw/termux/termux-so-atexit/&title=Termux and atexit in Android"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://yumaokao.github.io/tw/termux/termux-so-atexit/&title=Termux and atexit in Android"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://yumaokao.github.io/tw/termux/termux-so-atexit/&name=Termux and atexit in Android&description=&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&#34;https://termux.com/&#34;&gt;Termux&lt;/a&gt; 的作者 &lt;strong&gt;&lt;a href=&#34;https://twitter.com/fornwall&#34;&gt;@fornwall&lt;/a&gt;**，在2017/4/16發了一個 **&lt;a href=&#34;https://github.com/termux/termux-packages/issues/933&#34;&gt;Issue #933&lt;/a&gt;**，
說在使用 **&lt;code&gt;libgpg-error&lt;/code&gt;&lt;/strong&gt; 時遇到一些問題。&lt;/p&gt;
&lt;/blockquote&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://yumaokao.github.io/tw/termux/termux-so-atexit/&t=Termux and atexit in Android"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Intro-to-termux-pacakges"><span class="toc-number">1.</span> <span class="toc-text">Intro to termux-pacakges</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Issue-933-in-termux-packages"><span class="toc-number">2.</span> <span class="toc-text">Issue #933 in termux-packages</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Patches-needed-for-gnupg2"><span class="toc-number">2.1.</span> <span class="toc-text">Patches needed for gnupg2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Difference-between-aarch64-and-arm"><span class="toc-number">2.2.</span> <span class="toc-text">Difference between aarch64 and arm ?</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#The-Condition-Android-Ver"><span class="toc-number">3.</span> <span class="toc-text">The Condition: Android Ver.</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Debug-atexit-with-abort"><span class="toc-number">3.1.</span> <span class="toc-text">Debug atexit with abort()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-stdin-stdout-and-stderr"><span class="toc-number">3.2.</span> <span class="toc-text">No stdin, stdout and stderr</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Test-Code-termux-so-atexit"><span class="toc-number">3.3.</span> <span class="toc-text">Test Code: termux-so-atexit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#attribute-constructor"><span class="toc-number">3.4.</span> <span class="toc-text">attribute ((constructor))</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Workaround-PR-1017"><span class="toc-number">3.5.</span> <span class="toc-text">Workaround PR #1017</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Executed-Order-of-atexit"><span class="toc-number">3.6.</span> <span class="toc-text">Executed Order of atexit()</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Root-Cause-bionic"><span class="toc-number">4.</span> <span class="toc-text">Root Cause: bionic</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#After-exit"><span class="toc-number">4.1.</span> <span class="toc-text">After exit()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#malloc-fini-impl-where-stdout-been-closed"><span class="toc-number">4.2.</span> <span class="toc-text">malloc_fini_impl, where stdout been closed</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gdb-test-to-look-at-functions-registered-with-atexit"><span class="toc-number">4.3.</span> <span class="toc-text">gdb test to look at functions registered with atexit()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Difference-before-main"><span class="toc-number">4.4.</span> <span class="toc-text">Difference before main()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Malloc-debug-is-must-on-Android-Marshmallow"><span class="toc-number">4.4.1.</span> <span class="toc-text">Malloc debug is must on Android Marshmallow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Malloc-debug-is-optional-on-Android-Nougat"><span class="toc-number">4.4.2.</span> <span class="toc-text">Malloc debug is optional on Android Nougat</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Termux and atexit in Android
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">yumaokao</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2017-05-16T03:29:38.000Z" itemprop="datePublished">2017-05-16</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/termux/">termux</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/android/" rel="tag">android</a>, <a class="tag-link-link" href="/tags/commandline/" rel="tag">commandline</a>, <a class="tag-link-link" href="/tags/termux/" rel="tag">termux</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <blockquote>
<p><a target="_blank" rel="noopener" href="https://termux.com/">Termux</a> 的作者 <strong><a target="_blank" rel="noopener" href="https://twitter.com/fornwall">@fornwall</a>**，在2017/4/16發了一個 **<a target="_blank" rel="noopener" href="https://github.com/termux/termux-packages/issues/933">Issue #933</a>**，
說在使用 **<code>libgpg-error</code></strong> 時遇到一些問題。</p>
</blockquote>
<a id="more"></a>

<h1 id="Intro-to-termux-pacakges"><a href="#Intro-to-termux-pacakges" class="headerlink" title="Intro to termux-pacakges"></a>Intro to termux-pacakges</h1><p><strong><a href="/2017/05/termux-env-setup/tw/#About-Termux">之前</a></strong> 有提過 <a target="_blank" rel="noopener" href="https://termux.com/">Termux</a> 是個在 Android 底下的終端模擬器，而附上了 <a target="_blank" rel="noopener" href="https://termux.com/">Termux</a>
套件系統，可以用 <strong><code>apt</code></strong> 來管理安裝。
<a target="_blank" rel="noopener" href="https://github.com/termux/termux-packages">termux-packages</a> 就是 <a target="_blank" rel="noopener" href="https://termux.com/">Termux</a> 編譯出這些套件的地方，裡面利用 <a target="_blank" rel="noopener" href="https://www.docker.com/">Docker</a>
來建構交叉編譯的環境。個別套件遇到的問題，就都會在 <a target="_blank" rel="noopener" href="https://github.com/termux/termux-packages">termux-packages</a> 發 issues
討論。</p>
<h1 id="Issue-933-in-termux-packages"><a href="#Issue-933-in-termux-packages" class="headerlink" title="Issue #933 in termux-packages"></a>Issue #933 in termux-packages</h1><p><a target="_blank" rel="noopener" href="https://termux.com/">Termux</a> 的作者 <strong><a target="_blank" rel="noopener" href="https://twitter.com/fornwall">@fornwall</a>**，在2017/4/16發了一個 **<a target="_blank" rel="noopener" href="https://github.com/termux/termux-packages/issues/933">Issue #933</a>**，
說在使用 **<code>libgpg-error</code></strong> 時遇到一些問題。</p>
<p><strong><a target="_blank" rel="noopener" href="https://github.com/termux/termux-packages/issues/933">Issue #933</a></strong> 裡面附上的 Sample Code</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GPGRT_ENABLE_ES_MACROS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;gpg-error.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123; es_putc(<span class="string">&#x27;A&#x27;</span>, es_stdout); &#125;</span><br></pre></td></tr></table></figure>
<p>用下列命令安裝執行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install -y clang libgpg-error-dev &amp;&amp; clang test.c -lgpg-error &amp;&amp; ./a.out</span><br></pre></td></tr></table></figure>
<p>理論上應該會要看到 <strong><code>A</code></strong> 顯示出來才對。但是只有在某些裝置才會顯示</p>
<ul>
<li><strong>Working</strong> (output produced): <strong>aarch64</strong> (tested on <strong>Android 7.0 and 7.1</strong> devices)</li>
<li><strong>Not working</strong> (no output produced): 32-bit <strong>arm</strong> (tested on an <strong>Android 6.0</strong>)</li>
</ul>
<h2 id="Patches-needed-for-gnupg2"><a href="#Patches-needed-for-gnupg2" class="headerlink" title="Patches needed for gnupg2"></a>Patches needed for gnupg2</h2><p>因為這個問題，所以沒有辦法只好在用到 <strong><code>libgpg-error</code></strong> 的程式，其實就是
<strong><code>gnupg2</code>**，裡面加上了一些 **patches</strong>。雖然可以暫時解掉，
但還是希望能夠有正解的分析，才能安心地從 <strong><code>gnupg1</code></strong> 轉換到 **<code>gnupg2</code>**。</p>
<h2 id="Difference-between-aarch64-and-arm"><a href="#Difference-between-aarch64-and-arm" class="headerlink" title="Difference between aarch64 and arm ?"></a>Difference between aarch64 and arm ?</h2><p>會對這個 Issue 引起興趣是因為 <strong><a target="_blank" rel="noopener" href="https://twitter.com/fornwall">@fornwall</a></strong> 猜測是 <strong>arch</strong> 的不同引起的差異。
個人之前在 <a target="_blank" rel="noopener" href="https://termux.com/">Termux</a> 上遇到問題的時候，也是很容易就會猜測是 <strong>arch</strong>
(e.g. x86_64) 不同造成的，有機會會另外寫一篇講這個，後來詳細追了下去
發覺其實都是 <strong>Android</strong> 本身系統問題，很難是 <strong>arch</strong> 造成的原因。</p>
<h1 id="The-Condition-Android-Ver"><a href="#The-Condition-Android-Ver" class="headerlink" title="The Condition: Android Ver."></a>The Condition: Android Ver.</h1><p>很快地把 <strong>Sample Code</strong> 編譯起來在自己的幾台機器跑了一下，發覺其實都印不出
**<code>A</code>**，哈哈哈。</p>
<blockquote><p>因為那時候手上還沒有 <strong>Andoird 7.x</strong> 的手機啊XD</p>
</blockquote>

<p>沒關係！ <strong>Android SDK</strong> 有出 <strong>Emulator</strong> 可以跑起來測試，為此還多抓了
<strong>Android 7.1</strong> 的 <strong>arm</strong> 的影像檔，可以跑起來但是慢慢的就是。</p>
<blockquote><p>順便該一下，現在要開新的 <strong>avd</strong> 都不能直接用 **<code>android</code>**了，很麻煩耶。</p>
</blockquote>

<blockquote><p>所以才趕緊搶隻<strong>便宜手機</strong>，趕緊刷到 <strong>Android 7.1</strong> 的嘛！（誤）</p>
</blockquote>

<p>測試結果看起來是 <strong>Android</strong> 版本的問題，而不是 <strong>arch</strong> 造成的。</p>
<ul>
<li><strong>Working</strong>: i686 (tested on <strong>Android 7.1 emulator</strong>)</li>
<li><strong>Not working</strong>: aarch64 (tested on an <strong>Android 6.0 device</strong>)</li>
</ul>
<p>好的，釐清了會發生問題的條件後，就來研究一下 <strong><code>libgpg-error</code></strong> 如何處理
<strong><code>es_putc</code>**，簡單看過之後，大致上就是有個 **estream</strong> 自行實現了
<strong>buffered</strong> 字串流功能，會等到 <strong>buffer</strong> 滿了之後再一塊刷出到 <strong>fd</strong>，
像是 <strong>stdout</strong> 或是 <strong>stderr</strong>。</p>
<p>那要是主程式程式要離開了，但 <strong>buffer</strong> 裡面還有東西該怎麼辦呢？
這時候會需要有個收尾的 <strong>function</strong> 來把還沒刷出去的給印出來，
不然就會覺得被吃掉了。</p>
<blockquote><p>這個收尾的 <strong>function</strong> 就叫作 <strong><code>do_deinit()</code>**，是透過 **libc</strong> 的
<strong><code>atexit()</code></strong> 註冊的。</p>
</blockquote>

<h2 id="Debug-atexit-with-abort"><a href="#Debug-atexit-with-abort" class="headerlink" title="Debug atexit with abort()"></a>Debug atexit with abort()</h2><p>馬上就來在 <strong><code>do_deinit()</code></strong> 前面很趕緊加個 <strong><code>fprintf(stderr)</code>**，
看看能不能印出東西來代表有沒有跑到。結果是不行的，沒有看到訊息被印出來，
所以直覺地認為在有問題的手機上 **<code>do_deinit</code></strong> 是沒有被跑到的。</p>
<p>那就來看看會跑到的手機，是怎麼進去這個收尾 <strong><code>do_deinit()</code></strong> 呢？
加個 <strong><code>abort()</code></strong> 在剛剛的 <strong><code>fprintf(stderr)</code></strong> 之後吧，
這樣就可以得到 <strong>core dump</strong> 了，有這個就可以 **<code>bt</code>**看是誰叫到了。</p>
<p><strong><a target="_blank" rel="noopener" href="https://termux.com/">Termux</a></strong> 很讚是，已經有 <strong><code>gdb</code></strong> 可以裝了，接著有疑問的地方是剛剛程式不是用
<strong><code>clang</code></strong> 編譯的嗎？這樣也可以用 <strong><code>gdb</code></strong> 嗎？其實是可以的啦。</p>
<blockquote><p>結果有問題的手機，也是會 <strong><code>abort</code></strong> 的，這表示都有跑到 <strong><code>do_deinit()</code></strong></p>
</blockquote>

<h2 id="No-stdin-stdout-and-stderr"><a href="#No-stdin-stdout-and-stderr" class="headerlink" title="No stdin, stdout and stderr"></a>No stdin, stdout and stderr</h2><p>看起來是 <strong><code>do_deinit()</code></strong> 有被叫到，但是 <strong><code>fprintf</code></strong> 沒有辦法印出東西來，
這太有趣了！什麼時候會遇到 <strong><code>printf</code></strong> 沒有辦法正常工作呢？</p>
<blockquote><p><strong><code>printf</code></strong> 可以說是 <strong>debug</strong> 的第一步啊XD</p>
</blockquote>

<p>既然有 <strong><code>gdb</code></strong> 了，那來中斷在 <strong><code>do_deinit()</code></strong> 的進入點上，看看這時候
<strong>/proc/PID/fd/</strong> 有哪裡不一樣吧。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ gdb ./issue933</span><br><span class="line">(gdb) b do_deinit</span><br><span class="line">(gdb) r</span><br><span class="line"></span><br><span class="line"><span class="comment"># On Not-working Devices</span></span><br><span class="line">$ ls -l /proc/3965/fd</span><br><span class="line"></span><br><span class="line"><span class="comment"># On Working Devices</span></span><br><span class="line">$ ls -l /proc/28326/fd</span><br><span class="line">total 0</span><br><span class="line">lrwx------ 1 u0_a101 u0_a101 64 May 17 11:32 0 -&gt; /dev/pts/1</span><br><span class="line">lrwx------ 1 u0_a101 u0_a101 64 May 17 11:32 1 -&gt; /dev/pts/1</span><br><span class="line">lrwx------ 1 u0_a101 u0_a101 64 May 17 11:32 2 -&gt; /dev/pts/1</span><br></pre></td></tr></table></figure>
<blockquote><p><strong>stdin, stdout, stderr</strong> 在這時候已經被清掉了啊啊啊啊XDDD</p>
</blockquote>

<h2 id="Test-Code-termux-so-atexit"><a href="#Test-Code-termux-so-atexit" class="headerlink" title="Test Code: termux-so-atexit"></a>Test Code: termux-so-atexit</h2><p>為了更加簡單釐清問題，寫了一個很基本的測試程式 <strong><a target="_blank" rel="noopener" href="https://github.com/yumaokao/termux-so-atexit">termux-so-atexit</a></strong>
來驗證會造成 <strong>stdout</strong> 消失的原因。**<a target="_blank" rel="noopener" href="https://github.com/yumaokao/termux-so-atexit">termux-so-atexit</a>**
會儘量把環境一步步逼近跟 <strong><a target="_blank" rel="noopener" href="https://github.com/termux/termux-packages/issues/933">Issue #933</a></strong> 一樣，
這樣就可以知道是什麼部份差異所造成的。</p>
<p>只要有裝好 <strong><a target="_blank" rel="noopener" href="https://termux.com/">Termux</a></strong> 可以很容易安裝以及跑這個測試程式。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ apt install hub</span><br><span class="line">$ hub <span class="built_in">clone</span> yumaokao/termux-so-atexit</span><br><span class="line">$ <span class="built_in">cd</span> termux-so-atexit</span><br><span class="line"></span><br><span class="line"><span class="comment"># On Not-working Devices</span></span><br><span class="line">$ make test_atexit-so-constructor</span><br><span class="line">Should see messages and aborted</span><br><span class="line">make: *** [Makefile:15: test_atexit-so-constructor] Aborted</span><br><span class="line"></span><br><span class="line"><span class="comment"># On Working Devices</span></span><br><span class="line">$ make test_atexit-so-constructor</span><br><span class="line">Should see messages and aborted</span><br><span class="line">atexit called from shared library</span><br><span class="line">make: *** [Makefile:15: test_atexit-so-constructor] Aborted</span><br></pre></td></tr></table></figure>
<h2 id="attribute-constructor"><a href="#attribute-constructor" class="headerlink" title="attribute ((constructor))"></a><strong>attribute</strong> ((<strong>constructor</strong>))</h2><p>經過了 <strong><a target="_blank" rel="noopener" href="https://github.com/yumaokao/termux-so-atexit">termux-so-atexit</a></strong> 的逼近，確定只要符合底下的條件，
就會發生 <strong>stdout</strong> 消失的問題。</p>
<ol>
<li>使用 <strong><code>Android 7.0</code></strong> 以前的版本</li>
<li><strong><code>atexit()</code></strong> 是在被宣告有 <strong><code>__attribute__ ((__constructor__))</code></strong> 的函數裡呼叫的</li>
</ol>
<p><strong><code>libgpg-error</code></strong> 就是這樣，它會判斷編譯器是不是支援
<strong><code>__attribute__ ((__constructor__))</code></strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* gpg-error.h */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> _GPG_ERR_GCC_VERSION &gt; 30100</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> _GPG_ERR_CONSTRUCTOR	__attribute__ ((__constructor__))</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> _GPG_ERR_HAVE_CONSTRUCTOR</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> _GPG_ERR_CONSTRUCTOR</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Initialize the library.  This function should be run early.  */</span></span><br><span class="line"><span class="function"><span class="keyword">gpg_error_t</span> <span class="title">gpg_err_init</span> <span class="params">(<span class="keyword">void</span>)</span> _GPG_ERR_CONSTRUCTOR</span>;</span><br></pre></td></tr></table></figure>
<p>而 <strong><code>gpg_err_init()</code></strong> 最後會叫到 **<code>_gpgrt_estream_init()</code>**，
終於在這裡註冊了 **<code>atexit</code>**。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* estream.c */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">_gpgrt_estream_init (<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span> initialized;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!initialized)</span><br><span class="line">    &#123;</span><br><span class="line">      initialized = <span class="number">1</span>;</span><br><span class="line">      atexit (do_deinit);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Workaround-PR-1017"><a href="#Workaround-PR-1017" class="headerlink" title="Workaround PR #1017"></a>Workaround PR #1017</h2><p>知道是這個 <strong><code>__attribute__ ((__constructor__))</code></strong> 造成的，那要怎麼避開這個問題呢？</p>
<p>首先先來看看要是平台不支援這種 <strong><strong>constructor</strong></strong> 的話，
<strong><code>libgpg-error</code></strong> 會如何處理。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* gpg-error.h */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* If this is defined, the library is already initialized by the</span></span><br><span class="line"><span class="comment">   constructor and does not need to be initialized explicitely.  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> GPG_ERR_INITIALIZED</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _GPG_ERR_HAVE_CONSTRUCTOR</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> GPG_ERR_INITIALIZED	1</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> gpgrt_init() do &#123; gpg_err_init (); &#125; while (0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> gpgrt_init() do &#123; ; &#125; while (0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<blockquote><p>個人認為這邊是寫錯的，<strong>gpgrt_init()</strong> 的定義應該反過來才對啊？！</p>
</blockquote>

<p>好吧，<strong>將錯就錯</strong>！反正現在即使有 <strong><code>__attribute__ ((__constructor__))</code></strong>
也還是會再進去 <strong><code>_gpgrt_estream_init()</code></strong> 一次就是。</p>
<blockquote><p>那麼就改成可以再註冊一次 <strong><code>atexit(do_deinit)</code></strong> 就可以了！（神奇吧！哈哈！）</p>
</blockquote>
<p>底下就是送出去給 <strong><a target="_blank" rel="noopener" href="https://github.com/termux/termux-packages">termux-packages</a></strong> 的 <strong>Pull Request</strong> <strong><a target="_blank" rel="noopener" href="https://github.com/termux/termux-packages/pull/1017">PR #1017</a></strong></p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   static int initialized;</span><br><span class="line"></span><br><span class="line"><span class="addition">+#ifdef __ANDROID__</span></span><br><span class="line"><span class="addition">+  if (initialized &lt; 2)</span></span><br><span class="line"><span class="addition">+#else</span></span><br><span class="line">   if (!initialized)</span><br><span class="line"><span class="addition">+#endif</span></span><br><span class="line">     &#123;</span><br><span class="line">       initialized = 1;</span><br><span class="line">       atexit (do_deinit);</span><br></pre></td></tr></table></figure>
<h2 id="Executed-Order-of-atexit"><a href="#Executed-Order-of-atexit" class="headerlink" title="Executed Order of atexit()"></a>Executed Order of atexit()</h2><p>為什麼這樣修正 <strong>(<a target="_blank" rel="noopener" href="https://github.com/termux/termux-packages/pull/1017">PR #1017</a>)</strong> 就可以正常印出字串到 <strong>stdout</strong> 了呢？根據
<strong><code>atexit()</code></strong> 的 <strong>manual</strong> 所描述</p>
<blockquote><p>Functions so registered are called in the <strong><code>reverse order</code></strong> of their registration;</p>
</blockquote>

<p>簡單地說就是個 <strong>Stack</strong> 或是 <strong>First In Last Out</strong> 的架構。</p>
<p>所以進入 <strong>main()</strong> 後再被註冊的 <strong><code>do_deinit()</code></strong> 會先被執行到，
而這時候 <strong>stdout, stderr</strong> 等的 <strong>fd</strong> 還在，就可以正常刷出還在 <strong>buffer</strong>
裡的字串到螢幕上了。</p>
<p><strong><a target="_blank" rel="noopener" href="https://github.com/termux/termux-packages/pull/1017">PR #1017</a></strong> 很快就被 <strong>merged</strong> 了，即使還是個 <strong>workaround</strong>，
但跟原本的比起來，至少在一處做比多個用到 <strong>libgpg-error</strong> 的地方改還乾淨一點。</p>
<h1 id="Root-Cause-bionic"><a href="#Root-Cause-bionic" class="headerlink" title="Root Cause: bionic"></a>Root Cause: bionic</h1><blockquote><p>有沒有發現，上面講了這麼多，其實真正的原因還沒找到耶！（驚）</p>
</blockquote>

<h2 id="After-exit"><a href="#After-exit" class="headerlink" title="After exit()"></a>After exit()</h2><p>好吧，所以來找找看關於 <strong><code>atexit()</code></strong> 的部份是不是有相關的變動，
不然怎麼會新的 <strong>Android 7.x</strong> 就沒問題了呢？那麼來找找看 <strong><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/bionic.git">Bionic</a></strong>
原始碼在程式離開之後是怎麼叫到被 <strong><code>atexit()</code></strong> 註冊的 <strong>functions</strong>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">libc/stdlib/<span class="built_in">exit</span>.c</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line"><span class="built_in">exit</span>(<span class="keyword">int</span> status)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Call functions registered by atexit() or _cxa_atexit()</span></span><br><span class="line"><span class="comment">     * (including the stdio cleanup routine) and then _exit().</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    __cxa_finalize(<span class="literal">NULL</span>);</span><br><span class="line">    _exit(status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">libc/stdlib/atexit.c</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">__cxa_finalize(<span class="keyword">void</span> *dso)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">for</span> (p = __atexit; p != <span class="literal">NULL</span>; p = p-&gt;next) &#123;</span><br><span class="line">        <span class="keyword">for</span> (n = p-&gt;ind; --n &gt;= <span class="number">0</span>;) &#123;</span><br><span class="line">            fn = p-&gt;fns[n];</span><br><span class="line">            (*fn.fn_ptr)(fn.fn_arg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">extern</span> <span class="keyword">void</span> __libc_stdio_cleanup(<span class="keyword">void</span>);</span><br><span class="line">    __libc_stdio_cleanup();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>喔！抓到了，看起來 <strong><code>__libc_stdio_cleanup()</code></strong> 就很像是關掉 <strong>stdout</strong> 的人啊！
本來以為是這樣，但其實 <strong>並不是喔！</strong> 因為它只做 <strong><code>fflush()</code></strong> 而已啊啊啊！！</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">libc/stdio/stdio.c</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> __LIBC_HIDDEN__ <span class="keyword">void</span> __libc_stdio_cleanup(<span class="keyword">void</span>) &#123;</span><br><span class="line">  <span class="comment">// Equivalent to fflush(nullptr), but without all the locking since we&#x27;re shutting down anyway.</span></span><br><span class="line">  _fwalk(__sflush);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="malloc-fini-impl-where-stdout-been-closed"><a href="#malloc-fini-impl-where-stdout-been-closed" class="headerlink" title="malloc_fini_impl, where stdout been closed"></a>malloc_fini_impl, where stdout been closed</h2><p>好吧，只好再繼續找找看誰會 <strong><code>fclose(stdout)</code>**，然後又可能會在樓上的
**<code>__cxa_finalize()</code></strong> 裡被叫到。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">libc/bionic/malloc_common.cpp</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">malloc_init_impl</span><span class="params">(libc_globals* globals)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  info_log(<span class="string">&quot;%s: malloc debug enabled&quot;</span>, getprogname());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> ret_value = __cxa_atexit(malloc_fini_impl, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>);</span><br><span class="line">  <span class="keyword">if</span> (ret_value != <span class="number">0</span>) &#123;</span><br><span class="line">    error_log(<span class="string">&quot;failed to set atexit cleanup function: %d&quot;</span>, ret_value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">malloc_fini_impl</span><span class="params">(<span class="keyword">void</span>*)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Our BSD stdio implementation doesn&#x27;t close the standard streams,</span></span><br><span class="line">  <span class="comment">// it only flushes them. Other unclosed FILE*s will show up as</span></span><br><span class="line">  <span class="comment">// malloc leaks, but to avoid the standard streams showing up in</span></span><br><span class="line">  <span class="comment">// leak reports, close them here.</span></span><br><span class="line">  fclose(<span class="built_in">stdin</span>);</span><br><span class="line">  fclose(<span class="built_in">stdout</span>);</span><br><span class="line">  fclose(<span class="built_in">stderr</span>);</span><br><span class="line"></span><br><span class="line">  g_debug_finalize_func();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>啊原來是 <strong>BSD</strong> 實作本來就不會關掉 <strong>stdout</strong>，是為了 <strong>debug malloc leaks</strong>，
會檢查有還沒關掉的 <strong>fd</strong>，所以才用 **<code>malloc_fini_impl()</code>**，把它們關掉的。</p>
<blockquote><p>這實在太有趣了XD</p>
</blockquote>

<h2 id="gdb-test-to-look-at-functions-registered-with-atexit"><a href="#gdb-test-to-look-at-functions-registered-with-atexit" class="headerlink" title="gdb test to look at functions registered with atexit()"></a>gdb test to look at functions registered with atexit()</h2><p>所以到底為什麼 <strong>Android 7 Nougat</strong> 就沒有問題， <strong>Android 6 Marshmallow</strong>就會
<strong>GG</strong> 咧？對啦，真的就是上面的 <strong><code>malloc_fini_impl()</code></strong> 有沒有被叫到的差異。</p>
<p>可以利用 <strong><code>gdb</code></strong> 以及 <strong><a target="_blank" rel="noopener" href="https://github.com/yumaokao/termux-so-atexit">termux-so-atexit</a></strong> 來檢查看看喔。稍微改一下，讓
<strong><code>so_atexit</code></strong> 可以被跑到兩次。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># On Not-working Devices</span><br><span class="line">$ make gdb_atexit-so-constructor</span><br><span class="line">(gdb) b so_atexit</span><br><span class="line">(gdb) b malloc_fini_impl</span><br><span class="line">(gdb) r</span><br><span class="line">Breakpoint 1, so_atexit () at soatexit.c:5</span><br><span class="line"></span><br><span class="line">(gdb) c</span><br><span class="line">Breakpoint 2, 0x0000007fb7eb91d8 in malloc_fini_impl() () from &#x2F;system&#x2F;lib64&#x2F;libc.so</span><br><span class="line">(gdb) info os files</span><br><span class="line">14608      atexit-so-const 0          &#x2F;dev&#x2F;pts&#x2F;1</span><br><span class="line">14608      atexit-so-const 1          &#x2F;dev&#x2F;pts&#x2F;1</span><br><span class="line">14608      atexit-so-const 2          &#x2F;dev&#x2F;pts&#x2F;1</span><br><span class="line"></span><br><span class="line">(gdb) c</span><br><span class="line">Breakpoint 1, so_atexit () at soatexit.c:5</span><br><span class="line">(gdb) info os files</span><br></pre></td></tr></table></figure>
<p>由以上的 <strong><code>gdb</code></strong> 結果可以知道：</p>
<ol>
<li><strong><code>malloc_fini_impl()</code></strong> 有被執行到，而且夾在兩次 <strong><code>so_atexit()</code></strong> 的中間</li>
<li><strong>第二次的</strong> <strong><code>so_atexit()</code></strong> 就看不到 <strong>stdout</strong> 了</li>
</ol>
<blockquote><p>相同的 <strong><code>gdb</code></strong> 測試步驟，在 <strong>Android 7</strong> 的手機上，
是不會停在 <strong><code>malloc_fini_impl()</code></strong> 的</p>
</blockquote>

<h2 id="Difference-before-main"><a href="#Difference-before-main" class="headerlink" title="Difference before main()"></a>Difference before main()</h2><p>最後來分別看一下 <strong>Android 7</strong> 與 <strong>Android 6</strong> 的 <strong><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/bionic.git">Bionic</a></strong> 原始碼，
以驗證上面所有看到的現象是合理的。</p>
<h3 id="Malloc-debug-is-must-on-Android-Marshmallow"><a href="#Malloc-debug-is-must-on-Android-Marshmallow" class="headerlink" title="Malloc debug is must on Android Marshmallow"></a>Malloc debug is must on Android Marshmallow</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">libc/bionic/libc_init_dynamic.cpp</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * - a program launch function (__libc_init), which is called after</span></span><br><span class="line"><span class="comment"> *   all dynamic linking has been performed. Technically, it is called</span></span><br><span class="line"><span class="comment"> *   from arch-$ARCH/bionic/crtbegin_dynamic.S which is itself called</span></span><br><span class="line"><span class="comment"> *   by the dynamic linker after all libraries have been loaded and</span></span><br><span class="line"><span class="comment"> *   initialized.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">__noreturn <span class="keyword">void</span> __libc_init(<span class="keyword">void</span>* raw_args,</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (structors-&gt;fini_array) &#123;</span><br><span class="line">    __cxa_atexit(__libc_fini,structors-&gt;fini_array,<span class="literal">NULL</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">libc/bionic/libc_init_common.cpp</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> __libc_fini(<span class="keyword">void</span>* <span class="built_in">array</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">extern</span> <span class="keyword">void</span> __libc_postfini(<span class="keyword">void</span>) __attribute__((weak));</span><br><span class="line">    <span class="keyword">if</span> (__libc_postfini) &#123;</span><br><span class="line">      __libc_postfini();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">libc/bionic/libc_init_dynamic.cpp</span><br><span class="line"></span><br><span class="line">__LIBC_HIDDEN__ <span class="keyword">void</span> __libc_postfini() &#123;</span><br><span class="line">  <span class="comment">// A hook for the debug malloc library to let it know that we&#x27;re shutting down.</span></span><br><span class="line">  malloc_debug_fini();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">libc/bionic/malloc_debug_common.cpp</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">__LIBC_HIDDEN__ <span class="keyword">void</span> <span class="title">malloc_debug_fini</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">pthread_once_t</span> malloc_fini_once_ctl = PTHREAD_ONCE_INIT;</span><br><span class="line">  <span class="keyword">if</span> (pthread_once(&amp;malloc_fini_once_ctl, malloc_fini_impl)) &#123;</span><br><span class="line">    error_log(<span class="string">&quot;Unable to finalize malloc_debug component.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在 <strong>Android 6</strong> 時，是把 <strong><code>libc_fini()</code></strong> 註冊到 <strong><code>atexit</code></strong> 中，
而當程式離開的時候，會從這裡一路呼叫到 <strong><code>malloc_debug_fini()</code>**。
到這裡竟然會用 **<code>pthread_once()</code></strong> 叫一次 <strong><code>malloc_fini_impl()</code>**，
也就是剛剛說的會把 **stdout</strong> 等等關掉的 <strong>function</strong>。</p>
<p>再稍微看一下 <strong><code>libc_fini()</code></strong> 的 <strong>comments</strong> ，就會發現到這一路的
<strong><code>atexit()</code></strong> 是發生在 <strong>dynamic linking</strong> 準備好之後了。
把之前的例子 <strong><a target="_blank" rel="noopener" href="https://github.com/yumaokao/termux-so-atexit">termux-so-atexit</a></strong> 註冊 <strong><code>atexit()</code></strong> 的時序圖畫一下，
大概是這樣子：</p>
<div class="mermaid">
  graph LR
    subgraph atexit register order
    soatexit0("so_atexit<br/>- __constructor__") --> __libc_fini("__libc_fini")
    __libc_fini("__libc_fini<br/>- fclose(stdout)") -->|"main()"| soatexit1("so_atexit<br/>- after main()")
    end
</div>


<p>如果還記得最前面有說到， <strong><code>atexit()</code></strong> 有說執行的時候，
是要按造註冊的順序反過來的，所以如上圖的順序，就會了解到原本一開始用
<strong><code>__constructor__</code></strong> 註冊的 <strong><code>so_atexit()</code></strong> 為什麼會看到 <strong>stdout</strong>
等等不見的情形了。</p>
<h3 id="Malloc-debug-is-optional-on-Android-Nougat"><a href="#Malloc-debug-is-optional-on-Android-Nougat" class="headerlink" title="Malloc debug is optional on Android Nougat"></a>Malloc debug is optional on Android Nougat</h3><p>再看看看現在比較新一點的 <strong>Android 7</strong> 會呼叫到 <strong><code>malloc_fini_impl</code></strong> 的相關流程。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">libc/bionic/libc_init_dynamic.cpp</span><br><span class="line"></span><br><span class="line">__attribute__((constructor)) <span class="keyword">static</span> <span class="keyword">void</span> __libc_preinit() &#123;</span><br><span class="line">  ...</span><br><span class="line">  __libc_init_globals(*args);</span><br><span class="line">  __libc_init_common(*args);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Hooks for various libraries to let them know that we&#x27;re starting up.</span></span><br><span class="line">  __libc_globals.mutate(__libc_init_malloc);</span><br><span class="line">  netdClientInit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">libc/bionic/malloc_common.cpp</span><br><span class="line"></span><br><span class="line">__LIBC_HIDDEN__ <span class="keyword">void</span> __libc_init_malloc(libc_globals* globals) &#123;</span><br><span class="line">  malloc_init_impl(globals);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">malloc_init_impl</span><span class="params">(libc_globals* globals)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> value[PROP_VALUE_MAX];</span><br><span class="line">  <span class="keyword">if</span> (__system_property_get(DEBUG_MALLOC_PROPERTY_OPTIONS, value) == <span class="number">0</span> || value[<span class="number">0</span>] == <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  info_log(<span class="string">&quot;%s: malloc debug enabled&quot;</span>, getprogname());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> ret_value = __cxa_atexit(malloc_fini_impl, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看起來在 <strong>Android 7</strong> 這是個 <strong>debug</strong> 選項，必須要用 <strong>setprop</strong> 設定一些參數，
才能讓 <strong><code>malloc_fini_impl</code></strong> 被註冊，不然預設是不會被叫到的，
也因為這樣才沒有遇到 <strong><a target="_blank" rel="noopener" href="https://github.com/termux/termux-packages/issues/933">Issue #933</a></strong></p>
<blockquote><p>完全就是個美麗的誤會，而不是 <strong>Bionic</strong> 發現到有這種問題而修正的XD</p>
</blockquote>

<blockquote><p>結論是不要在 <strong><code>atexit</code></strong> 的 <strong>function</strong> 中假設 <strong>stdout</strong> 還在啊啊啊！！</p>
</blockquote>


<!-- <a href="/tw/termux/termux-env-setup/" title="Termux Environment Setup Script">Termux Environment Setup Script</a> -->

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">root</a></li>
         
          <li><a href="/archives/">archives</a></li>
         
          <li><a href="/categories/">categories</a></li>
         
          <li><a href="/tags/">tags</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Intro-to-termux-pacakges"><span class="toc-number">1.</span> <span class="toc-text">Intro to termux-pacakges</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Issue-933-in-termux-packages"><span class="toc-number">2.</span> <span class="toc-text">Issue #933 in termux-packages</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Patches-needed-for-gnupg2"><span class="toc-number">2.1.</span> <span class="toc-text">Patches needed for gnupg2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Difference-between-aarch64-and-arm"><span class="toc-number">2.2.</span> <span class="toc-text">Difference between aarch64 and arm ?</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#The-Condition-Android-Ver"><span class="toc-number">3.</span> <span class="toc-text">The Condition: Android Ver.</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Debug-atexit-with-abort"><span class="toc-number">3.1.</span> <span class="toc-text">Debug atexit with abort()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-stdin-stdout-and-stderr"><span class="toc-number">3.2.</span> <span class="toc-text">No stdin, stdout and stderr</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Test-Code-termux-so-atexit"><span class="toc-number">3.3.</span> <span class="toc-text">Test Code: termux-so-atexit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#attribute-constructor"><span class="toc-number">3.4.</span> <span class="toc-text">attribute ((constructor))</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Workaround-PR-1017"><span class="toc-number">3.5.</span> <span class="toc-text">Workaround PR #1017</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Executed-Order-of-atexit"><span class="toc-number">3.6.</span> <span class="toc-text">Executed Order of atexit()</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Root-Cause-bionic"><span class="toc-number">4.</span> <span class="toc-text">Root Cause: bionic</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#After-exit"><span class="toc-number">4.1.</span> <span class="toc-text">After exit()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#malloc-fini-impl-where-stdout-been-closed"><span class="toc-number">4.2.</span> <span class="toc-text">malloc_fini_impl, where stdout been closed</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gdb-test-to-look-at-functions-registered-with-atexit"><span class="toc-number">4.3.</span> <span class="toc-text">gdb test to look at functions registered with atexit()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Difference-before-main"><span class="toc-number">4.4.</span> <span class="toc-text">Difference before main()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Malloc-debug-is-must-on-Android-Marshmallow"><span class="toc-number">4.4.1.</span> <span class="toc-text">Malloc debug is must on Android Marshmallow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Malloc-debug-is-optional-on-Android-Nougat"><span class="toc-number">4.4.2.</span> <span class="toc-text">Malloc debug is optional on Android Nougat</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://yumaokao.github.io/tw/termux/termux-so-atexit/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://yumaokao.github.io/tw/termux/termux-so-atexit/&text=Termux and atexit in Android"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://yumaokao.github.io/tw/termux/termux-so-atexit/&title=Termux and atexit in Android"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yumaokao.github.io/tw/termux/termux-so-atexit/&is_video=false&description=Termux and atexit in Android"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Termux and atexit in Android&body=Check out this article: http://yumaokao.github.io/tw/termux/termux-so-atexit/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://yumaokao.github.io/tw/termux/termux-so-atexit/&title=Termux and atexit in Android"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://yumaokao.github.io/tw/termux/termux-so-atexit/&title=Termux and atexit in Android"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://yumaokao.github.io/tw/termux/termux-so-atexit/&title=Termux and atexit in Android"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://yumaokao.github.io/tw/termux/termux-so-atexit/&title=Termux and atexit in Android"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://yumaokao.github.io/tw/termux/termux-so-atexit/&name=Termux and atexit in Android&description=&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&#34;https://termux.com/&#34;&gt;Termux&lt;/a&gt; 的作者 &lt;strong&gt;&lt;a href=&#34;https://twitter.com/fornwall&#34;&gt;@fornwall&lt;/a&gt;**，在2017/4/16發了一個 **&lt;a href=&#34;https://github.com/termux/termux-packages/issues/933&#34;&gt;Issue #933&lt;/a&gt;**，
說在使用 **&lt;code&gt;libgpg-error&lt;/code&gt;&lt;/strong&gt; 時遇到一些問題。&lt;/p&gt;
&lt;/blockquote&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://yumaokao.github.io/tw/termux/termux-so-atexit/&t=Termux and atexit in Android"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2017-2020
    yumaokao
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">root</a></li>
         
          <li><a href="/archives/">archives</a></li>
         
          <li><a href="/categories/">categories</a></li>
         
          <li><a href="/tags/">tags</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->


</body>
</html>
